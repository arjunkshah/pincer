(()=>{"use strict";const e="https://YOUR-NETLIFY-SITE.netlify.app/.netlify/functions/groq-proxy",t="llama-3.1-8b-instant",n=new Map;async function o(n,o,s){const r=function(e){const t={plain:"Write in plain language. Use common words. Keep sentences short.",grade5:"Write at a 5th grade reading level. Use simple vocabulary. Avoid complex sentence structures.",bullets:"Focus on the bullet_version field. Break all information into clear, short bullet points.",steps:"Focus on the step_version field. Convert all instructions into numbered steps.",literal:"Write in literal_version. Avoid all metaphors, idioms, and figurative language. Be completely literal and direct.",actions:"Focus on actions_detected. List only the specific actions the user needs to take. Ignore background information."};return`You are Pincer, an AI accessibility assistant. Your job is to rewrite web page text to be more accessible.\n\nRules:\n- Use short sentences (max 15 words each).\n- Avoid jargon, technical terms, and idioms.\n- Preserve all factual meaning â€” never invent new facts.\n- Tone must be neutral, calm, and supportive.\n- Return ONLY a JSON object with the following keys:\n  {\n    "simplified_text": "...",\n    "bullet_version": ["...", "..."],\n    "step_version": ["Step 1: ...", "Step 2: ..."],\n    "literal_version": "...",\n    "actions_detected": ["...", "..."],\n    "deadlines_detected": ["..."]\n  }\n\nMode: ${t[e]||t.plain}`}(o),i=`Rewrite the following web page text according to your instructions. Return ONLY valid JSON.\n\nTEXT:\n${n}`,a=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:t,messages:[{role:"system",content:r},{role:"user",content:i}],temperature:.3,response_format:{type:"json_object"}})});if(!a.ok){const e=await a.text();throw new Error(`Groq API error ${a.status}: ${e}`)}const c=await a.json(),l=c.choices?.[0]?.message?.content||"{}";try{return JSON.parse(l)}catch{return{simplified_text:l}}}chrome.runtime.onMessage.addListener((s,r,i)=>"AI_REWRITE"===s.type?(async function(e,t){try{const{text:s,mode:r}=e;const c=`${s.slice(0,80)}::${r}`,l=n.get(c);if(l&&Date.now()-l.ts<6e5)return void t({data:l.data});const p=function(e,t){if(e.length<=t)return[e];const n=[];let o=0;for(;o<e.length;){let s=o+t;if(s<e.length){const t=e.lastIndexOf(".",s);t>o+1500&&(s=t+1)}n.push(e.slice(o,s).trim()),o=s}return n}(s,3e3),d=[];for(const e of p){const t=await o(e,r);d.push(t)}const u=function(e){return 1===e.length?e[0]:{simplified_text:e.map(e=>e.simplified_text||"").join("\n\n"),bullet_version:e.flatMap(e=>e.bullet_version||[]),step_version:e.flatMap(e=>e.step_version||[]),literal_version:e.map(e=>e.literal_version||"").join("\n\n"),actions_detected:e.flatMap(e=>e.actions_detected||[]),deadlines_detected:e.flatMap(e=>e.deadlines_detected||[])}}(d);n.set(c,{data:u,ts:Date.now()}),t({data:u})}catch(e){console.error("[Pincer] AI rewrite error:",e),t({error:e.message})}}(s,i),!0):"CALM_REWRITE"===s.type?(async function(n,o){try{const{texts:s}=n;if(!s||0===s.length)return void o({replacements:[]});const a='You are Pincer Calm Mode. Your job is to rewrite anxiety-inducing, aggressive, or urgent-sounding text into calm, neutral language.\n\nRules:\n- Keep the same factual meaning.\n- Remove urgency, threats, and aggressive tone.\n- Use simple, reassuring language.\n- Return ONLY a JSON object: { "replacements": [{ "original": "...", "calm": "..." }, ...] }',c=`Rewrite these alert/notice texts to be calm and neutral:\n${JSON.stringify(s)}`,l=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:t,messages:[{role:"system",content:a},{role:"user",content:c}],temperature:.3,response_format:{type:"json_object"}})});if(!l.ok)return void o({replacements:[]});const p=await l.json(),d=p.choices?.[0]?.message?.content||"{}";o({replacements:JSON.parse(d).replacements||[]})}catch(e){console.error("[Pincer] Calm rewrite error:",e),o({replacements:[]})}}(s,i),!0):"AI_TOOLTIP"===s.type?(async function(n,o){try{const{elementHtml:s}=n;const a=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:t,messages:[{role:"system",content:"Describe what this HTML element does in one short, plain sentence. Be literal. Max 15 words."},{role:"user",content:s}],temperature:.2,max_tokens:60})}),c=await a.json();o({text:c.choices?.[0]?.message?.content?.trim()||null})}catch{o({text:null})}}(s,i),!0):void 0)})();